<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Firebase Delivery</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    window.firebaseUtils = { initializeApp, getDatabase, ref, onValue };
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f4f4f4; }
    h1 { color: #333; }
    label, input, button, select { font-size: 16px; margin-top: 10px; }
    .result, .explicacao { margin-top: 20px; padding: 15px; background: #e0f7fa; border-radius: 8px; }
    .explicacao { background: #fff3e0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #ffe0b2; }
    #grafico, #graficoClientes { margin-top: 40px; }
    .tabs { margin-top: 20px; }
    .tab-button { padding: 10px 20px; cursor: pointer; background: #42a5f5; color: white; border: none; border-radius: 4px; margin-right: 5px; }
    .tab-button.active { background: #ef6c00; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .cliente-form { margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; }
    .action-btn { margin: 0 2px; padding: 4px 8px; cursor: pointer; border-radius: 4px; border: none; }
    .edit-btn { background: #42a5f5; color: white; }
    .delete-btn { background: #ef5350; color: white; }
  </style>
</head>
<body>
  <h1>Previs√£o de Investimento por Cliente</h1>

  <div class="tabs">
    <button class="tab-button active" data-tab="geral">Calculadora Geral</button>
    <button class="tab-button" data-tab="clientes">Custos por Cliente</button>
  </div>

  <!-- ABA 1: Calculadora Geral -->
  <div id="geral" class="tab-content active">
    <div class="explicacao">
      <h3>üîç Explica√ß√£o das Vari√°veis</h3>
      <ul>
        <li><strong>Pedidos por dia:</strong> Quantos pedidos seu app recebe diariamente.</li>
        <li><strong>Tamanho por pedido (KB):</strong> Espa√ßo que cada pedido ocupa no banco. Exemplo real: ~1 KB.</li>
        <li><strong>Leituras por pedido:</strong> Quantas vezes os dados de um pedido s√£o acessados (cliente, entregador, admin).</li>
        <li><strong>Produtos cadastrados:</strong> Quantidade de itens no card√°pio.</li>
        <li><strong>Tamanho por produto (KB):</strong> Espa√ßo m√©dio que cada produto ocupa no banco. Exemplo real: ~0.46 KB.</li>
        <li><strong>Armazenamento:</strong> Espa√ßo ocupado pelos dados no Firebase. Cobrado por GB/m√™s.</li>
        <li><strong>Download:</strong> Dados lidos pelos usu√°rios. Cada leitura consome tr√°fego. Cobrado por GB/m√™s.</li>
      </ul>
    </div>

    <label for="pedidos">Pedidos por dia:</label><br>
    <input type="number" id="pedidos" value="200"><br>

    <label for="tamanho">Tamanho por pedido (KB):</label><br>
    <input type="number" id="tamanho" value="1"><br>

    <label for="leituras">Leituras por pedido:</label><br>
    <input type="number" id="leituras" value="3"><br>

    <label for="produtos">Quantidade de produtos cadastrados:</label><br>
    <input type="number" id="produtos" value="100"><br>

    <label for="tamanhoProduto">Tamanho por produto (KB):</label><br>
    <input type="number" id="tamanhoProduto" value="0.46"><br><br>

    <button onclick="calcular()">Calcular</button>

    <div class="result" id="resultado"></div>
    <div id="grafico" style="width: 100%; height: 500px;"></div>
  </div>

  <!-- ABA 2: Custos por Cliente -->
  <div id="clientes" class="tab-content">
    <div class="cliente-form">
      <h3>‚ûï Cadastrar Cliente / Banco Firebase</h3>
      <label>Nome do Cliente:</label><br>
      <input type="text" id="clienteNome"><br>
      <label>URL do Banco Firebase:</label><br>
      <input type="text" id="clienteBanco"><br>
      <label>Leituras por pedido:</label><br>
      <input type="number" id="clienteLeituras" value="3"><br>
      <label>Tamanho m√©dio por pedido (KB):</label><br>
      <input type="number" id="clienteTamanho" value="1"><br>
      <label>Tamanho m√©dio por produto (KB):</label><br>
      <input type="number" id="clienteTamanhoProduto" value="0.46"><br><br>
      <button onclick="adicionarCliente()">Adicionar Cliente</button>
    </div>

    <h3>üìä Custos por Cliente</h3>
    <div class="result" id="clientesResultado"></div>
    <div id="graficoClientes" style="width: 100%; height: 500px;"></div>
  </div>

  <script type="text/javascript">
    google.charts.load('current', {packages: ['corechart']});

    // === TABS NAVIGATION ===
    const tabs = document.querySelectorAll('.tab-button');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // === Calculadora Geral ===
    function calcular() {
      const pedidosDia = parseFloat(document.getElementById('pedidos').value);
      const tamanhoKB = parseFloat(document.getElementById('tamanho').value);
      const leituras = parseFloat(document.getElementById('leituras').value);
      const produtos = parseFloat(document.getElementById('produtos').value);
      const tamanhoProdutoKB = parseFloat(document.getElementById('tamanhoProduto').value);

      const diasMes = 30;
      const cotacao = 5.43;

      const MBporDia = (pedidosDia * tamanhoKB) / 1024;
      const GBarmazenamentoMensalPedidos = (MBporDia * diasMes) / 1024;
      const armazenamentoProdutosGB = (produtos * tamanhoProdutoKB) / 1024;
      const GBarmazenamentoMensalTotal = GBarmazenamentoMensalPedidos + armazenamentoProdutosGB;
      const GBdownloadMensalTotal = GBarmazenamentoMensalTotal * leituras;

      const custoBRL = (GBarmazenamentoMensalTotal*0.18 + GBdownloadMensalTotal*0.12) * cotacao;

      let tabela = `
        <h3>üìä Resultados Mensais:</h3>
        - Armazenamento de pedidos: ${GBarmazenamentoMensalPedidos.toFixed(4)} GB/m√™s<br>
        - Armazenamento de produtos: ${armazenamentoProdutosGB.toFixed(4)} GB<br>
        - Armazenamento total: ${GBarmazenamentoMensalTotal.toFixed(4)} GB/m√™s<br>
        - Download estimado: ${GBdownloadMensalTotal.toFixed(4)} GB/m√™s<br>
        - Custo Firebase absoluto: R$ ${custoBRL.toFixed(2)}<br><br>
      `;
      document.getElementById('resultado').innerHTML = tabela;
    }

    // === Aba Clientes ===
    let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
    let editarIndex = null;

    function adicionarCliente(){
      const cliente = {
        nome: document.getElementById('clienteNome').value,
        banco: document.getElementById('clienteBanco').value,
        leituras: parseFloat(document.getElementById('clienteLeituras').value),
        tamanhoPedido: parseFloat(document.getElementById('clienteTamanho').value),
        tamanhoProduto: parseFloat(document.getElementById('clienteTamanhoProduto').value)
      };

      if(editarIndex !== null){
        clientes[editarIndex] = cliente;
        editarIndex = null;
      } else {
        clientes.push(cliente);
      }

      localStorage.setItem('clientes', JSON.stringify(clientes));
      document.getElementById('clienteNome').value = '';
      document.getElementById('clienteBanco').value = '';
      carregarClientes();
    }

    function editarCliente(index){
      const c = clientes[index];
      document.getElementById('clienteNome').value = c.nome;
      document.getElementById('clienteBanco').value = c.banco;
      document.getElementById('clienteLeituras').value = c.leituras;
      document.getElementById('clienteTamanho').value = c.tamanhoPedido;
      document.getElementById('clienteTamanhoProduto').value = c.tamanhoProduto;
      editarIndex = index;
    }

    function excluirCliente(index){
      clientes.splice(index,1);
      localStorage.setItem('clientes', JSON.stringify(clientes));
      carregarClientes();
    }

    async function carregarClientes(){
      const cotacao = 5.43;
      let tabela = `<table><tr><th>Cliente</th><th>Pedidos</th><th>Produtos</th><th>Armazenamento (GB)</th><th>Download (GB)</th><th>Custo R$</th><th>A√ß√µes</th></tr>`;
      let dadosGrafico = [['Cliente','Custo Firebase (R$)']];
      let totalCusto = 0;

      for (let i=0;i<clientes.length;i++){
        const c = clientes[i];
        try{
          const app = firebaseUtils.initializeApp({databaseURL:c.banco}, c.nome);
          const db = firebaseUtils.getDatabase(app);
          const pedidosRef = firebaseUtils.ref(db,'pedidos');
          const produtosRef = firebaseUtils.ref(db,'produtos');

          await new Promise(resolve=>{
            firebaseUtils.onValue(pedidosRef, pedidosSnap=>{
              const pedidosData = pedidosSnap.val() || {};
              const pedidosCount = Object.keys(pedidosData).length;

              firebaseUtils.onValue(produtosRef, produtosSnap=>{
                const produtosData = produtosSnap.val() || {};
                const produtosCount = Object.keys(produtosData).length;

                const MBporDia = (pedidosCount * c.tamanhoPedido)/1024;
                const armazenamentoPedidosGB = (MBporDia*30)/1024;
                const armazenamentoProdutosGB = (produtosCount * c.tamanhoProduto)/1024;
                const armazenamentoTotalGB = armazenamentoPedidosGB + armazenamentoProdutosGB;
                const downloadGB = armazenamentoTotalGB * c.leituras;
                const custoBRL = (armazenamentoTotalGB*0.18 + downloadGB*0.12)*cotacao;

                totalCusto += custoBRL;
                tabela += `<tr>
                  <td>${c.nome}</td>
                  <td>${pedidosCount}</td>
                  <td>${produtosCount}</td>
                  <td>${armazenamentoTotalGB.toFixed(4)}</td>
                  <td>${downloadGB.toFixed(4)}</td>
                  <td>R$ ${custoBRL.toFixed(2)}</td>
                  <td>
                    <button class="action-btn edit-btn" onclick="editarCliente(${i})">Editar</button>
                    <button class="action-btn delete-btn" onclick="excluirCliente(${i})">Excluir</button>
                  </td>
                </tr>`;
                dadosGrafico.push([c.nome, custoBRL]);
                resolve();
              });
            });
          });
        } catch(e){ console.error('Erro cliente', c.nome,e); }
      }

      tabela += `</table>`;
      tabela += `<h3>Total Estimado Firebase: R$ ${totalCusto.toFixed(2)}</h3>`;
      document.getElementById('clientesResultado').innerHTML = tabela;

      google.charts.setOnLoadCallback(()=>{
        const data = google.visualization.arrayToDataTable(dadosGrafico);
        const options = { title:'üìä Custo absoluto por Cliente', hAxis:{title:'Cliente'}, vAxis:{title:'Custo (R$)'}, colors:['#ef6c00'] };
        const chart = new google.visualization.ColumnChart(document.getElementById('graficoClientes'));
        chart.draw(data, options);
      });
    }

    carregarClientes();
  </script>
</body>
</html>
