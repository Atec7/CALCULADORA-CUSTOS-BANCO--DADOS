<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Financeiro AtecSeven</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
window.firebaseUtils={initializeApp,getDatabase,ref,onValue};
</script>
<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:#0b1d33;color:#fff;}
header{background:#102a4a;padding:25px;text-align:center;font-size:28px;font-weight:bold;color:#e0e1dd;}
.container{max-width:1400px;margin:auto;padding:20px;}
h2{color:#e0e1dd;margin-bottom:10px;}
input,button{font-size:16px;margin-top:10px;padding:8px;border-radius:4px;border:none;}
input{width:100%;box-sizing:border-box;}
button{cursor:pointer;background:#005f99;color:#fff;transition:0.3s;}
button:hover{background:#0077b6;}
.tabs{margin-bottom:20px;display:flex;flex-wrap:wrap;gap:5px;}
.tab-button{padding:10px 20px;cursor:pointer;background:#023e8a;color:#fff;border-radius:4px;}
.tab-button.active{background:#0077b6;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.cliente-form{background:#1b2a47;padding:20px;border-radius:8px;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#102a4a;}
th,td{border:1px solid #415a77;padding:10px;text-align:center;}
th{background-color:#023e8a;}
.action-btn{padding:5px 10px;border-radius:4px;border:none;cursor:pointer;margin:0 2px;}
.edit-btn{background:#0077b6;color:#fff;}
.delete-btn{background:#ef233c;color:#fff;}
.kpi-container{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:20px;}
.kpi{flex:1;min-width:180px;background:#1b2a47;padding:20px;border-radius:8px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.3);transition:0.3s;}
.kpi h3{margin:0;font-size:14px;color:#a8dadc;}
.kpi p{font-size:22px;margin:5px 0 0;color:#f1faee;font-weight:bold;}
#graficoClientes,#graficoFaturamento{margin-top:30px;height:500px;}
.btn-clean{background:#ef6c00;color:#fff;margin-top:10px;}
</style>
</head>
<body>
<header>Painel Financeiro AtecSeven Tecnologia</header>
<div class="container">
  <div class="tabs">
    <button class="tab-button active" data-tab="clientesTab">Clientes</button>
    <button class="tab-button" data-tab="indicadoresTab">KPIs & GrÃ¡ficos</button>
  </div>
  <div id="clientesTab" class="tab-content active">
    <div class="cliente-form">
      <h2>âž• Cadastrar Cliente</h2>
      <label>Nome do Cliente:</label>
      <input type="text" id="clienteNome"><br>
      <label>URL do Banco Firebase:</label>
      <input type="text" id="clienteBanco"><br>
      <label>Mensalidade do Cliente (R$):</label>
      <input type="number" id="clienteMensalidade"><br><br>
      <button onclick="adicionarCliente()">Adicionar / Salvar Cliente</button>
      <button class="btn-clean" onclick="limparClientes()">Limpar Todos os Clientes</button>
    </div>
    <div id="clientesResultado"></div>
  </div>
  <div id="indicadoresTab" class="tab-content">
    <h2>ðŸ“Š KPIs e GrÃ¡ficos</h2>
    <div class="kpi-container">
      <div class="kpi"><h3>Clientes Ativos</h3><p id="kpiClientes">0</p></div>
      <div class="kpi"><h3>Armazenamento Total (GB)</h3><p id="kpiArmazenamento">0</p></div>
      <div class="kpi"><h3>Download Total (GB)</h3><p id="kpiDownload">0</p></div>
      <div class="kpi"><h3>Despesas Firebase (R$)</h3><p id="kpiFirebase">0</p></div>
      <div class="kpi"><h3>Faturamento Bruto (R$)</h3><p id="kpiBruto">0</p></div>
      <div class="kpi"><h3>Faturamento LÃ­quido (R$)</h3><p id="kpiLiquido">0</p></div>
      <div class="kpi"><h3>% do Faturamento no Firebase</h3><p id="kpiPercentFirebase">0%</p></div>
      <div class="kpi"><h3>Cliente Mais Caro (R$)</h3><p id="kpiClienteCaro">0</p></div>
      <div class="kpi"><h3>Cliente Mais Lucrativo (R$)</h3><p id="kpiClienteLucro">0</p></div>
    </div>
    <div id="graficoClientes"></div>
    <div id="graficoFaturamento"></div>
    <button onclick="carregarClientes()">ðŸ”„ Atualizar Agora</button>
  </div>
</div>
<script type="text/javascript">
google.charts.load('current',{packages:['corechart']});
const tabs=document.querySelectorAll('.tab-button');
const contents=document.querySelectorAll('.tab-content');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
  tabs.forEach(t=>t.classList.remove('active'));
  contents.forEach(c=>c.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById(tab.dataset.tab).classList.add('active');
}));
let clientes=JSON.parse(localStorage.getItem('clientes'))||[];
let editarIndex=null;

function adicionarCliente(){
  const cliente={nome:document.getElementById('clienteNome').value,banco:document.getElementById('clienteBanco').value,mensalidade:parseFloat(document.getElementById('clienteMensalidade').value)||0};
  if(editarIndex!==null){clientes[editarIndex]=cliente;editarIndex=null;}else clientes.push(cliente);
  localStorage.setItem('clientes',JSON.stringify(clientes));
  limparFormCliente();
  carregarClientes();
}
function limparFormCliente(){
  document.getElementById('clienteNome').value='';
  document.getElementById('clienteBanco').value='';
  document.getElementById('clienteMensalidade').value='';
}
function editarCliente(index){
  const c=clientes[index];
  document.getElementById('clienteNome').value=c.nome;
  document.getElementById('clienteBanco').value=c.banco;
  document.getElementById('clienteMensalidade').value=c.mensalidade;
  editarIndex=index;
}
function excluirCliente(index){clientes.splice(index,1);localStorage.setItem('clientes',JSON.stringify(clientes));carregarClientes();}
function limparClientes(){if(confirm('Deseja realmente limpar todos os clientes?')){clientes=[];localStorage.setItem('clientes',JSON.stringify(clientes));carregarClientes();}}

async function carregarClientes(){
  const cotacao=5.43;
  let clientesAtivos=0, armazenamentoTotal=0, downloadTotal=0, custoFirebaseTotal=0, faturamentoBruto=0;
  let maiorCusto=0, maiorLucro=0;
  const tabela=document.getElementById('clientesResultado');
  tabela.innerHTML=`<table><tr><th>Cliente</th><th>Armazenamento (GB)</th><th>Download (GB)</th><th>Despesas Firebase (R$)</th><th>Mensalidade (R$)</th><th>AÃ§Ãµes</th></tr></table>`;
  const tabelaBody=tabela.querySelector('table');

  for(let index=0;index<clientes.length;index++){
    const c=clientes[index];
    try{
      const app=firebaseUtils.initializeApp({databaseURL:c.banco},c.nome);
      const db=firebaseUtils.getDatabase(app);
      const pedidosSnap=await new Promise(res=>firebaseUtils.onValue(firebaseUtils.ref(db,'pedidos'),snap=>res(snap.val())));
      const produtosSnap=await new Promise(res=>firebaseUtils.onValue(firebaseUtils.ref(db,'produtos'),snap=>res(snap.val())));
      const pedidosData=pedidosSnap||{};
      const produtosData=produtosSnap||{};
      const pedidosCount=Object.keys(pedidosData).length;
      const produtosCount=Object.keys(produtosData).length;
      const tamanhoPedidoKB=1, tamanhoProdutoKB=0.46, leituras=3, diasMes=30;
      const MBporDia=(pedidosCount*tamanhoPedidoKB)/1024;
      const GBarmazenamentoPedidos=(MBporDia*diasMes)/1024;
      const armazenamentoProdutosGB=(produtosCount*tamanhoProdutoKB)/1024;
      const GBarmazenamentoTotal=GBarmazenamentoPedidos+armazenamentoProdutosGB;
      const GBdownloadTotalCliente=GBarmazenamentoTotal*leituras;
      const custoArmazenamentoUSD=GBarmazenamentoTotal*0.18;
      const custoDownloadUSD=GBdownloadTotalCliente*0.12;
      const custoTotalBRL=(custoArmazenamentoUSD+custoDownloadUSD)*cotacao;

      clientesAtivos++;
      armazenamentoTotal+=GBarmazenamentoTotal;
      downloadTotal+=GBdownloadTotalCliente;
      custoFirebaseTotal+=custoTotalBRL;
      faturamentoBruto+=c.mensalidade;
      if(custoTotalBRL>maiorCusto) maiorCusto=custoTotalBRL;
      if(c.mensalidade-custoTotalBRL>maiorLucro) maiorLucro=c.mensalidade-custoTotalBRL;

      const row=document.createElement('tr');
      row.innerHTML=`<td>${c.nome}</td><td>${GBarmazenamentoTotal.toFixed(4)}</td><td>${GBdownloadTotalCliente.toFixed(4)}</td>
      <td>${custoTotalBRL.toFixed(2)}</td><td>${c.mensalidade.toFixed(2)}</td>
      <td>
        <button class="action-btn edit-btn" onclick="editarCliente(${index})">Editar</button>
        <button class="action-btn delete-btn" onclick="excluirCliente(${index})">Excluir</button>
      </td>`;
      tabelaBody.appendChild(row);

    }catch(e){console.error(e);}
  }
  atualizarKPIs(clientesAtivos,armazenamentoTotal,downloadTotal,faturamentoBruto,custoFirebaseTotal,maiorCusto,maiorLucro);
  desenharGraficos();
}

function atualizarKPIs(ativos,armazenamentoTotal,downloadTotal,faturamentoBruto,custoFirebaseTotal,maiorCusto,maiorLucro){
  document.getElementById('kpiClientes').innerText=ativos;
  document.getElementById('kpiArmazenamento').innerText=armazenamentoTotal.toFixed(4);
  document.getElementById('kpiDownload').innerText=downloadTotal.toFixed(4);
  document.getElementById('kpiFirebase').innerText=custoFirebaseTotal.toFixed(2);
  document.getElementById('kpiBruto').innerText=faturamentoBruto.toFixed(2);
  document.getElementById('kpiLiquido').innerText=(faturamentoBruto-custoFirebaseTotal).toFixed(2);
  document.getElementById('kpiPercentFirebase').innerText=(faturamentoBruto>0?((custoFirebaseTotal/faturamentoBruto)*100).toFixed(2):0)+'%';
  document.getElementById('kpiClienteCaro').innerText=maiorCusto.toFixed(2);
  document.getElementById('kpiClienteLucro').innerText=maiorLucro.toFixed(2);
}

function desenharGraficos(){
  google.charts.setOnLoadCallback(()=>{
    const dataClientes = google.visualization.arrayToDataTable([['Cliente','Despesas Firebase'],...clientes.map(c=>[c.nome,0])]);
    const chartClientes = new google.visualization.ColumnChart(document.getElementById('graficoClientes'));
    chartClientes.draw(dataClientes,{title:'Custo Firebase por Cliente',colors:['#00b4d8'],backgroundColor:'#0b1d33',hAxis:{textStyle:{color:'#fff'}},vAxis:{textStyle:{color:'#fff'}}});

    const dataFaturamento = google.visualization.arrayToDataTable([['Cliente','Mensalidade','Despesas Firebase'],...clientes.map(c=>[c.nome,c.mensalidade,0])]);
    const chartFaturamento = new google.visualization.ColumnChart(document.getElementById('graficoFaturamento'));
    chartFaturamento.draw(dataFaturamento,{title:'Faturamento x Custo Firebase',series:{0:{color:'#0077b6'},1:{color:'#00b4d8'}},backgroundColor:'#0b1d33',hAxis:{textStyle:{color:'#fff'}},vAxis:{textStyle:{color:'#fff'}}});
  });
}

carregarClientes();
setInterval(carregarClientes,30000);
</script>
</body>
</html>
